<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>My First2 Web Page</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <!--<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1356.0.min.js"></script>-->
    <script src="/js/amazon-cognito-identity.js"></script>
    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.es5.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/herrjemand/Base64URL-ArrayBuffer@latest/lib/base64url-arraybuffer.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>
<body>
    <div class="container fluid">
            <div class="row justify-content-center">
                <div class="col-lg-6">
                           <div class="border p-4 rounded">
                                <h2 class="text-center my-4">Registrera</h2>
                                    <form>
                                        <div class="form-group">
                                        <label for="email2">Email:</label>
                                        <input type="email" id="email2" name="email" class="form-control">
                                               </div>
                                        <input type="button" value="Registrera" id="register-btn" class="btn btn-primary mt-2">
                                    </form>
                            </div>
                    <p id="regSuccess" class="success"></p>
                    <p id="regError" class="error"></p>
                    <details open>
                        <summary>Console</summary>
                        <textarea id="regDebug" spellcheck="false"></textarea>
                    </details>

                </div>
                <div class="col-lg-6">
                    <div class="border p-4 rounded">
                        <h2 class="text-center my-4">Autentisera</h2>
                        <form>
                            <div class="form-group">
                                <label for="email">Email:</label>
                                <input type="email" id="authUsername" name="email" class="form-control">
                            </div>
                            <input type="button" value="Autentisera" onclick="AuthUser()" class="btn btn-primary mt-2">
                        </form>

                    </div>
                    <p id="authSuccess" class="success"></p>
                            <p id="authError" class="error"></p>
                            <details open>
                                <summary>Console</summary>
                                <textarea id="authDebug" spellcheck="false"></textarea>
                            </details>
                </div>
            </div>
    </div>

    <h2>
        WebAuthn with Cognito
    </h2>

    <div id="tabs">
        <ul>
            <li><a href="#tabs-1">Register</a></li>
            <li><a href="#tabs-2">Sign-in</a></li>
        </ul>
        <div id="tabs-1">
            <input class="w3-input"  type="text" id="reg-username" placeholder="username"/><br>
            <input class="w3-input"  type="password" id="reg-password" placeholder="password"/><br>
            <input class="w3-input" type="text" id="reg-email" placeholder="email"/><br>
            <input class="w3-input" type="text" id="reg-name" placeholder="name"/><br>
            <button class="w3-btn w3-black" onclick="createCredential()">Register with Authenticator</button>
        </div>
        <div id="tabs-2">
            <input class="w3-input" type="text" id="login-username" placeholder="username"/><br>
            <input class="w3-input" type="password" id="login-password" placeholder="password"/><br>
            <p>Sign-in experience:</p>
            <input class="w3-radio" type="radio" name="authentication" value="both" checked><label> Login with Password + FIDO</label><br>
            <input class="w3-radio" type="radio" name="authentication" value="password"><label> Login with Password Only</label><br>
            <input  class="w3-radio" type="radio" name="authentication" value="fido"><label> Password-less (FIDO only)</label><br><br>
            <button class="w3-btn w3-black" onclick="signIn()">Login</button>
        </div>
    </div>
    <br><br>
    <pre class="" id="idToken"></pre>
    <pre class="" id="accessToken"></pre>
    <pre class="" id="refreshToken"></pre>


    <script>
        /**
         * A simple way to control how debug content is writteddn to a debug console element
         */
        function printDebug(elemDebug, title, output) {
            if (elemDebug.innerHTML !== '') {
                elemDebug.innerHTML += '\n';
            }
            elemDebug.innerHTML += `// ${title}\n`;
            elemDebug.innerHTML += `${output}\n`;
        }



    let userPool;
      function getAmazonCognitoUserPool() {

        // We only need to create this object once, so let's only do so if we haven't already

          // A neat trick, we can determine the dynamically generated UserPoolId and ClientId from this page's headers (S3 Object Metadata)
          var poolData = {
              UserPoolId: 'eu-north-1_Mili80FJ6',
              ClientId: '4iq2f333ajd9ne279uqj6oqvs3'
          };

          userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

        return userPool;
      }

const { browserSupportsWebauthn, startRegistration, startAuthentication } = SimpleWebAuthnBrowser;
const { CognitoUserPool, CognitoUserAttribute, CognitoUser, AuthenticationDetails } = AmazonCognitoIdentity;

        document.getElementById('register-btn').addEventListener('click', async () => {
            const elemSuccess = document.querySelector('#regSuccess');
            const elemError = document.querySelector('#regError');
            const elemDebug = document.querySelector('#regDebug');

            // Reset success/error messages
            elemSuccess.innerHTML = '';
            elemError.innerHTML = '';
            elemDebug.innerHTML = '';

            // Register the user in Cognito
            userPool = await getAmazonCognitoUserPool();
            userPool.signUp(document.getElementById('email2').value, 'PasswordD123!', [new CognitoUserAttribute({
                Name: 'email',
                Value: document.getElementById('email2').value
            })], null, function (error, result) {

                // We want to allow users to register multiple authenticators to a single user account, so if the Cognito "signUp" fails with user exists, that's okay, ignore it
                if (!error || error.code == "UsernameExistsException") {

                    // Request the generated attestation options to begin webauthn enrollment
                    var cognitoUser = new CognitoUser({
                        Username: document.getElementById('email2').value,
                        Pool: userPool,
                    });
                    cognitoUser.setAuthenticationFlowType('CUSTOM_AUTH');
                    cognitoUser.initiateAuth(new AuthenticationDetails({
                        Username: cognitoUser.getUsername(),
                    }), {
                        customChallenge: async function(challengeParameters) {

                            let attResp;
                            try {
                                const opts = JSON.parse(challengeParameters.attestationChallenge);
                                printDebug(elemDebug, 'Registration Options', JSON.stringify(opts, null, 2));
                                attResp = await startRegistration(opts);
                                printDebug(elemDebug, 'Registration Response', JSON.stringify(attResp, null, 2));
                            } catch (error) {
                                if (error.name === 'InvalidStateError') {
                                    elemError.innerText = 'Error: Authenticator was probably already registered by user';
                                } else {
                                    elemError.innerText = error;
                                }

                                throw error;
                            }

                            // Send the authenticators response
                            try {
                                console.log('Sending response to Cognito');
                                console.log(attResp);
                                cognitoUser.sendCustomChallengeAnswer(JSON.stringify(attResp), this);
                            } catch (error) {
                                elemError.innerText = error;
                                throw error;
                            }
                        },
                        onSuccess: function (result) {
                            printDebug(elemDebug, 'Server Response', JSON.stringify(result, null, 2));
                            elemSuccess.innerHTML = `Authenticator registered!`;
                        },
                        onFailure: function (error) {
                            elemError.innerHTML = `Oh no, something went wrong! Response: <pre>${JSON.stringify(
                                error,
                            )}</pre>`;
                        }
                    });
                } else {
                    elemError.innerHTML = `Oh no, something went wrong! Response: <pre>${JSON.stringify(
                        error,
                    )}</pre>`;
                }
            });
        });

function AuthUser(){
    const elemSuccess = document.querySelector('#authSuccess');
          const elemError = document.querySelector('#authError');
          const elemDebug = document.querySelector('#authDebug');

          // Reset success/error messages
          elemSuccess.innerHTML = '';
          elemError.innerHTML = '';
          elemDebug.innerHTML = '';

          // Request the generated assertion options to begin webauthn authentication
          userPool = getAmazonCognitoUserPool();
          var cognitoUser = new CognitoUser({
            Username: document.getElementById('authUsername').value,
	          Pool: userPool,
          });
          cognitoUser.setAuthenticationFlowType('CUSTOM_AUTH');
          cognitoUser.initiateAuth(new AuthenticationDetails({
              Username: cognitoUser.getUsername()
            }), {
              customChallenge: async function(challengeParameters) {

                let asseResp;
                try {
                  const opts = JSON.parse(challengeParameters.assertionChallenge);
                  printDebug(elemDebug, 'Authentication Options', JSON.stringify(opts, null, 2));
                  asseResp = await startAuthentication(opts);
                  printDebug(elemDebug, 'Authentication Response', JSON.stringify(asseResp, null, 2));
                } catch (error) {
                  elemError.innerText = error;
                  throw new Error(error);
                }

                // Send the authenticators response
                cognitoUser.sendCustomChallengeAnswer(JSON.stringify(asseResp), this);
              },
              onSuccess: function (result) {
                printDebug(elemDebug, 'Server Response', JSON.stringify(result, null, 2));
                elemSuccess.innerHTML = `User authenticated!`;
              },
              onFailure: function (error) {
                elemError.innerHTML = `Oh no, something went wrong! Response: <pre>${JSON.stringify(
                  error,
                )}</pre>`;
              }
          });


};

        let globalRegisteredCredentials = "";
        let globalRegisteredCredentialsJSON = {};

        userPool = getAmazonCognitoUserPool();

        //create credentials using platform or roaming authenticator
        createCredential = async () => {

            try {

                //build the credentials options requirements
                var credOptionsRequest = {
                    attestation: 'none',
                    username: $("#reg-username").val() ,
                    name: $("#reg-username").val(),
                    authenticatorSelection: {
                        authenticatorAttachment: ['platform','cross-platform'],
                        userVerification: 'preferred',
                        requireResidentKey: false
                    }
                };

                //generate credentials request to be sent to navigator.credentials.create
                var credOptions = await _fetch('/authn/createCredRequest' , credOptionsRequest);
                var challenge = credOptions.challenge;
                credOptions.user.id = base64url.decode(credOptions.user.id);
                credOptions.challenge = base64url.decode(credOptions.challenge);

                //----------create credentials using available authenticator
                const cred = await navigator.credentials.create({
                    publicKey: credOptions
                });

                // parse credentials response to extract id and public-key, this is the information needed to register the user in Cognito
                const credential = {};
                credential.id =     cred.id;
                credential.rawId =  base64url.encode(cred.rawId);
                credential.type =   cred.type;
                credential.challenge = challenge;

                if (cred.response) {
                    const clientDataJSON = base64url.encode(cred.response.clientDataJSON);
                    const attestationObject = base64url.encode(cred.response.attestationObject);
                    credential.response = {
                        clientDataJSON,
                        attestationObject
                    };
                }

                credResponse = await _fetch('/authn/parseCredResponse' , credential);

                globalRegisteredCredentialsJSON = {id: credResponse.credId,publicKey: credResponse.publicKey};
                globalRegisteredCredentials = JSON.stringify(globalRegisteredCredentialsJSON);
                console.log(globalRegisteredCredentials);

                //----------credentials have been created, now sign-up the user in Cognito
                signUp();

            } catch (e) {console.error(e);}
        };

        //---------------Cognito sign-up
        signUp = async () =>{

            var email = $("#reg-email").val();
            var username = $("#reg-username").val();
            var password =$("#reg-password").val();
            var name = $("#reg-name").val();
            var publicKeyCred = btoa(globalRegisteredCredentials);//base64 encode credentials json string (credId, public-key)

            var attributeList = [];

            var dataEmail = {Name: 'email',Value: email};
            var dataName = { Name: 'name',Value: name};
            var dataPublicKeyCred = { Name: 'custom:publicKeyCred',Value: publicKeyCred};

            var attributeEmail = new AmazonCognitoIdentity.CognitoUserAttribute(dataEmail);
            var attributePublicKeyCred = new AmazonCognitoIdentity.CognitoUserAttribute(dataPublicKeyCred);
            var attributeName = new AmazonCognitoIdentity.CognitoUserAttribute(dataName);

            attributeList.push(attributeEmail);
            attributeList.push(attributePublicKeyCred);
            attributeList.push(attributeName);

            userPool.signUp(username, password, attributeList, null, function(err, result ) {
                if (err) {
                    console.log(err.message || JSON.stringify(err));
                    return;
                }else{
                    var cognitoUser = result.user;

                    var confirmationCode = prompt("Please enter confirmation code:");
                    cognitoUser.confirmRegistration(confirmationCode, true, function(err, result) {
                        if (err) {
                            alert(err.message || JSON.stringify(err));
                            return;
                        }
                        console.log('call result: ' + result);
                        alert("Registration successful, now sign-in.");
                    });

                    console.log('user name is ' + cognitoUser.getUsername());
                }
            });
        }


        //---------------Cognito sign-in user
        signIn = async () => {

            var username = $("#login-username").val();
            var password = $("#login-password").val();
            var flow = $("input[name='authentication']:checked").val();

            var authenticationData = {
                Username: username, //only username required since we will authenticate user using custom auth flow and will use security key
                Password: password
            };

            var userData = {
                Username: username,
                Pool: userPool,
            };

            var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
            cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

            if(flow === 'password'){ //sign-in using password only

                /**
                 authenticateUser method will trigger authentication with USER_SRP_AUTH flow
                 USER_SRP_AUTH doesn't trigger define auth challenge, this will just authenticate the user using password
                 (if SMS/TOTP MFA is configured for the user it will also be triggered)
                 **/
                cognitoUser.authenticateUser(authenticationDetails, authCallBack);

            }else if(flow === 'fido'){ // sign-in using FIDO authenticator only
                /**
                 initiateAuth method will trigger authentication with CUSTOM_AUTH flow and will not provide any challenge data initially
                 This will allow define auth challenge to respond with CUSTOM_CHALLENGE
                 **/

                cognitoUser.setAuthenticationFlowType('CUSTOM_AUTH');
                cognitoUser.initiateAuth(authenticationDetails, authCallBack);

            }else{ //sign-in with password and use FIDO for 2nd factor
                /**
                 authenticateUser method will trigger authentication with CUSTOM_AUTH flow and will provide SRP_A as the challenge
                 This will allow define auth challenge to authenticate user using SRP first and then respond with CUSTOM_AUTH
                 **/

                cognitoUser.setAuthenticationFlowType('CUSTOM_AUTH');
                cognitoUser.authenticateUser(authenticationDetails, authCallBack);

            }
        }

        authCallBack = {

            onSuccess: function(result) {
                var accessToken = result.getAccessToken().getJwtToken();
                var idToken = result.getIdToken().getJwtToken();
                var refreshToken = result.getRefreshToken().getToken();

                $("#idToken").html('<b>ID Token</b><br>'+JSON.stringify(parseJwt(idToken),null, 2));
                $("#accessToken").html('<b>Access Token</b><br>'+JSON.stringify(parseJwt(accessToken), null, 2));
                //$("#refreshToken").html('<b>Refresh Token</b><br>'+refreshToken);

            },
            customChallenge: async function(challengeParameters) {
                // User authentication depends on challenge response

                console.log("Custom Challenge from Cognito:");console.log(challengeParameters);


                //----------get creds from security key or platform authenticator
                var signinOptions = {
                    "challenge": base64url.decode(challengeParameters.challenge),//challenge was generated and sent from CreateAuthChallenge lambda trigger
                    "timeout":1800000,
                    "rpId":window.location.hostname,
                    "userVerification":"preferred",
                    "allowCredentials":[
                        {
                            "id": base64url.decode(challengeParameters.credId),
                            "type":"public-key",
                            "transports":["ble","nfc","usb","internal"]
                        }
                    ]
                }

                //get sign in credentials from authenticator
                const cred = await navigator.credentials.get({
                    publicKey: signinOptions
                });

                //prepare credentials challenge response
                const credential = {};
                if (cred.response) {
                    const clientDataJSON = base64url.encode(cred.response.clientDataJSON);
                    const authenticatorData = base64url.encode(cred.response.authenticatorData);
                    const signature = base64url.encode(cred.response.signature);
                    const userHandle = base64url.encode(cred.response.userHandle);

                    credential.response = {clientDataJSON, authenticatorData, signature, userHandle};
                }

                //send credentials to Cognito VerifyAuthChallenge lambda trigger for verification
                cognitoUser.sendCustomChallengeAnswer(JSON.stringify(credential), this);

            },
            onFailure: function(err) {
                console.error("Error authenticateUser:"+err);
                console.log(err.message || JSON.stringify(err));
            },
        }

        //---------------------Set of helper functions-----------------------//
        //------------------------------------------------------------------//

        //tabs UI
        $( function() {
            $( "#tabs" ).tabs();
        } );

        //helper function
        _fetch = async (path, payload = '') => {
            const headers = {'X-Requested-With': 'XMLHttpRequest'};
            if (payload && !(payload instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
                payload = JSON.stringify(payload);
            }
            const res = await fetch(path, {
                method: 'POST',
                credentials: 'same-origin',
                headers: headers,
                body: payload
            });
            if (res.status === 200) {
                return res.json();
            } else {
                const result = await res.json();
                throw result.error;
            }
        };

        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace('-', '+').replace('_', '/');
            return JSON.parse(window.atob(base64));
        };


    </script>

</body>
</html>
